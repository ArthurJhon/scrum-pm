<%#= tag("embed", :width => 900, :height => 200, :type => "image/svg+xml",
    :src => url_for(:controller => 'sprints', :action => 'svg_graph',
        :project_id => @project, :id => @sprint.id), :method => :post) %>

<%# form_for :sprint, :url => '/sprints/show', :method => :get do |select_form| %>
<% form_tag({:controller => :sprints, :action => :show},{:method =>  :get}) do  %>
  <p><%= label_tag 'Iteracje:' -%>
    <%= collection_select( :sprint, :id, Version.find_all_by_project_id(@project.id), :id, :name, {:selected => @sprint.id }) -%>
    <%= submit_tag 'Wybierz' %>
  </p>
<% end %>


<% data = load_sprint_stats(@sprint, []) %>
<div class="sprint_fieldset">
  <div class="sprint_header" >
    <table class="dashboard_main_table" cellspacing=0 cellpadding=0>
      <tr>
        <td style="width: 30%;">
          <b id="<%= "sprint_name_#{@sprint.id}" %>"><%=h @sprint.name %></b>
        </td>
        <td class="tab_sprint_done_text" id="<%= "sprint_percent_done_#{@sprint.id}" %>">
          <%= render(:partial => "shared/percent_done", :locals => {:data => data}) %>
        </td>
        <td class="tab_sprint_links">
          <%= link_to image_tag("/plugin_assets/redmine_sprints/images/edit.png"),
            {:controller => :sprints, :action => :edit, :project_id => @project, :id => @sprint.id},
            {:id => "new_us", :title => "Edycja sprintu",
            :onclick => "Modalbox.show(this.href, {title: this.title, width: 370}); return false;"}
          %>
          <%= link_to_object(@sprint, "destroy", "delete") %>
          <%= link_to_new_object("user_story", @sprint, "story_add") %>
        </td>
      </tr>
      <tr >
        <td class="tab_sprint_target" colspan="3" id="<%= "sprint_target_#{@sprint.id}" %>">Opis sprintu: <%=h @sprint.description %></td>
      </tr>
      <tr id="<%= "sprint_dates_and_points_#{@sprint.id}" %>">
        <%= render(:partial => "sprints/sprint_dates_and_points", :locals => {:data => data, :sprint => @sprint}) %>
      </tr>
    </table>
  </div>

<div class="dashboard_sprint">

  <div class="user_stories">
      <% count = 0 %>
      <table class="dashboard_main_table" cellspacing=0 cellpadding=0>
        <tr>
          <th class="tab_us_header">Historia użytkownika</th>
          <th class="tab_fill"></th>
          <th class="tab_us_pending_header"><%= image_tag("/plugin_assets/redmine_sprints/images/pending.png", :class => "middle") %> Oczekujące</th>
          <th class="tab_us_inprogress_header"><%= image_tag("/plugin_assets/redmine_sprints/images/inprogress.png", :class => "middle") %> W trakcie wykonywanie</th>
          <th class="tab_us_done_header"><%= image_tag("/plugin_assets/redmine_sprints/images/done.png", :class => "middle") %> Wykonane</th>
        </tr>
        <% for user_story in @sprint.user_stories %>
          <tr class="<%= classify( count )  %>">
                <td class="tab_us_main">
                  <%= image_tag("/plugin_assets/redmine_sprints/images/us-top.png") %>
                <table>
                  <tr >
                    <td><div class="tab_sprint_user_story">#<%= user_story.id %></div></td>
                    <td class="tab_us_name"><%=h user_story.name %></td>
                    <td class="tab_us_links">
                      <%= link_to_object(user_story, "show", "story") %>
                      <%= link_to_object(user_story, "edit", "story_edit") %>
                      <%= link_to_object(user_story, "destroy", "story_delete") %>
                    </td>
                  </tr>
                  <tr>
                    <td colspan="3" class="tab_us_description">
                        <%= user_story.description -%>
                    </td>

                  </tr>
                  <tr>
                    <td colspan="2" class="tab_us_diagrams">
                      <div>
                      <% for diagram in user_story.diagrams %>
                        <%= lightbox_link_to image_tag(diagram.public_filename(:thumb)), diagram.public_filename %>
                        <%#= link_to image_tag(diagram.public_filename(:thumb)), diagram.public_filename, :class => "diagram_thumb" %>
                      <% end %>
                      </div>
                    </td>
                    <td class="tab_us_links">
                      <%#= link_to image_tag("/plugin_assets/redmine_sprints/images/diagram_add.png"), {:controller => 'diagrams', :action => 'new', :user_story_diagram =>user_story.id} %>

                      <%= link_to_new_object("diagram",user_story,"diagram_add") %>
                    </td>
                  </tr>
                  <tr>
                    <td colspan="2">
                      <p>
                        <%= image_tag("/plugin_assets/redmine_sprints/images/estimation.png", :class => "middle") %> <%= user_story.time_estimate.estimation -%>
                      </p>
                    </td>
                    <td  class="tab_us_links">
                      <%#= link_to_new_object("task",user_story,"task_add") %>
                      <%= link_to image_tag("/plugin_assets/redmine_sprints/images/task_add.png"),
                        {:controller => 'issue_sprints',:action => 'new', :project_id => @project, :user_story_id => user_story.id},
                        {:id => "new_us", :title => "Nowe zadanie",
                        :onclick => "Modalbox.show(this.href, {title: this.title, width: 900, height: 500}); return false;"
                        }
                      %>
                    </td>
                  </tr>
                </table>
                <%= image_tag("/plugin_assets/redmine_sprints/images/us-bottom.png") %>
                </td>
                <td></td>
                <td class="tab_us_align_top" id="<%= "tasks_1_us_#{user_story.id}" %>">
                <% for task in user_story.issues.find_all{|t| t.done_ratio == 0} %>
                  <%= render(:partial => "shared/task_view", :locals => { :task => task }) %>
                <% end %>
              </td>
              <td class="tab_us_align_top" id="<%= "tasks_2_us_#{user_story.id}" %>">
                <% for task in user_story.issues.find_all{|t| t.done_ratio > 0 && t.done_ratio < 100} %>
                  <%= render(:partial => "shared/task_view", :locals => { :task => task }) %>
                <% end %>
              </td>
              <td class="tab_us_align_top" id="<%= "tasks_3_us_#{user_story.id}" %>">
                <% for task in user_story.issues.find_all{|t| t.done_ratio == 100} %>
                  <%= render(:partial => "shared/task_view", :locals => { :task => task }) %>
                <% end %>
              </td>
              <%= drop_receiving_element("tasks_1_us_#{user_story.id}",
                #:before => "element.shrink();element.remove();",
                :accept => "us_task",
                :before => visual_effect(:highlight, "tasks_1_us_#{user_story.id}"),
                :success => "element.remove();",
                :with   => "'task_id=' + (element.id.split('_').last())",
                :hoverclass => 'hover',
                :url    => {:controller => :issue_sprints, :action => :status_change, :status_id => 1, :project_id => @project, :user_story_id => user_story.id }
                #"/projects/#{@project.identifier}/tasks/#{task.id}/status_change/#{task.status_id+1}"
              )%>
              <%= drop_receiving_element("tasks_2_us_#{user_story.id}",
                :accept => "us_task",
                :before => visual_effect(:highlight, "tasks_2_us_#{user_story.id}"),
                :success => "element.remove();",
                :with   => "'task_id=' + (element.id.split('_').last())",
                :hoverclass => 'hover',
                :url    => {:controller => :issue_sprints, :action => :status_change, :status_id => 2, :project_id => @project, :user_story_id => user_story.id }
              )%>
              <%= drop_receiving_element("tasks_3_us_#{user_story.id}",
                :accept => "us_task",
                :before => visual_effect(:highlight, "tasks_3_us_#{user_story.id}"),
                :success => "element.remove();",
                :with   => "'task_id=' + (element.id.split('_').last())",
                :hoverclass => 'hover',
                :url    => {:controller => :issue_sprints, :action => :status_change, :status_id => 3, :project_id => @project, :user_story_id => user_story.id }
              )%>
          </tr>
          <% count = 1 - count %>
        <% end %>
      </table>
    </div>

</div>
</div>
<% content_for :sidebar do %>
  <%#= tag("embed", :width => 700, :height => 300, :type => "image/svg+xml",
    :src => url_for(:controller => 'sprints', :action => 'svg_graph',
      :project_id => @project, :id => @sprint.id)) %>

          <%#= render(:partial => "shared/stats_form", :locals => {:sprint => @sprint}) %>
<% end %>


<% content_for :header_tags do %>
  <%= javascript_include_tag 'modalbox', :plugin => 'redmine_sprints' %>
  <%= stylesheet_link_tag 'modalbox', :plugin => 'redmine_sprints'  %>
  <%= stylesheet_link_tag 'tooltip', :plugin => 'redmine_sprints'  %>
  <%= stylesheet_link_tag 'tablesort', :plugin => 'redmine_sprints'  %>
  <%= javascript_include_tag 'fastinit', :plugin => 'redmine_sprints' %>
  <%= javascript_include_tag 'tablesort', :plugin => 'redmine_sprints' %>
  <%= stylesheet_link_tag 'scrum', :plugin => 'redmine_sprints' %>
  <%= stylesheet_link_tag 'spinbutton', :plugin => 'redmine_sprints' %>
  <%= javascript_include_tag 'spinbutton', :plugin => 'redmine_sprints' %>
  <%= stylesheet_link_tag 'lightbox'%>
  <%= javascript_include_tag('calendar/calendar') %>
  <%= javascript_include_tag("calendar/lang/calendar-#{current_language}.js") %>
  <%= javascript_include_tag('calendar/calendar-setup') %>
  <%= stylesheet_link_tag('calendar') %>
  <%= stylesheet_link_tag 'scm' %>
<% end %>
